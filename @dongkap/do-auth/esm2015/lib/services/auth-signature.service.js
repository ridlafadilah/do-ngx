import { Injectable, Inject } from '@angular/core';
import { HttpHeaders } from '@angular/common/http';
import { TranslateService } from '@ngx-translate/core';
import { DatePipe } from '@angular/common';
import { of, combineLatest } from 'rxjs';
import { switchMap, take } from 'rxjs/operators';
import { signatureHeader, OAUTH_INFO, oauthInfo } from '@dongkap/do-core';
import { DateFormat, EncryptionService } from '@dongkap/do-core';
import { AuthIndexedDBService } from '../storage/auth-indexeddb.service';
export class AuthSignatureService {
    constructor(translate, enc, oauthResource, authStorage) {
        this.translate = translate;
        this.enc = enc;
        this.oauthResource = oauthResource;
        this.authStorage = authStorage;
    }
    signHeaders(req) {
        return combineLatest([
            this.key(),
            this.signature(this.getPath(req.url)),
        ]).pipe(take(1), switchMap((value) => {
            if (signatureHeader.signature) {
                let httpHeaders = req.headers ? req.headers : new HttpHeaders();
                httpHeaders.keys().forEach((key) => {
                    if (key === signatureHeader.key)
                        httpHeaders = httpHeaders.delete(signatureHeader.key);
                    if (key === signatureHeader.timestamp)
                        httpHeaders = httpHeaders.delete(signatureHeader.timestamp);
                    if (key === signatureHeader.signature)
                        httpHeaders = httpHeaders.delete(signatureHeader.signature);
                });
                httpHeaders = httpHeaders.set(signatureHeader.key, value[0]);
                httpHeaders = httpHeaders.set(signatureHeader.timestamp, this.timestamp());
                httpHeaders = httpHeaders.set(signatureHeader.signature, value[1]);
                return of(req.clone({ headers: httpHeaders }));
            }
            return of(req);
        }));
    }
    key() {
        return this.authStorage.getOfEnc(oauthInfo.public_key);
    }
    timestamp() {
        return Math.floor(new Date().getTime() / 1000).toString();
    }
    date() {
        return new DatePipe(this.translate.currentLang).transform(new Date(), DateFormat.DATE);
    }
    signature(url) {
        return combineLatest([
            this.key(),
            this.authStorage.getOfEnc(oauthInfo.access_token),
        ]).pipe(take(1), switchMap((value) => {
            const key = value[0] + ':' +
                this.timestamp() + ':' +
                // this.date() + ':' +
                url + ':' +
                value[1];
            return of(this.enc.getHmacSha256(this.oauthResource['private_key'], key));
        }));
    }
    getPath(url) {
        return '/' + url
            .replace(/^(http:\/\/www\.|https:\/\/www\.|http:\/\/|https:\/\/)?[a-z0-9]+([\-\.]{1}[a-z0-9]+)*(:[0-9]{1,5})?(\/).*?/g, '');
    }
}
AuthSignatureService.ctorParameters = () => [
    { type: TranslateService },
    { type: EncryptionService },
    { type: undefined, decorators: [{ type: Inject, args: [OAUTH_INFO,] }] },
    { type: AuthIndexedDBService }
];
AuthSignatureService.decorators = [
    { type: Injectable }
];
AuthSignatureService.ctorParameters = () => [
    { type: TranslateService },
    { type: EncryptionService },
    { type: undefined, decorators: [{ type: Inject, args: [OAUTH_INFO,] }] },
    { type: AuthIndexedDBService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aC1zaWduYXR1cmUuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0Bkb25na2FwL2RvLWF1dGgvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvYXV0aC1zaWduYXR1cmUuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNuRCxPQUFPLEVBQUUsV0FBVyxFQUFlLE1BQU0sc0JBQXNCLENBQUM7QUFDaEUsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDdkQsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzNDLE9BQU8sRUFBYyxFQUFFLEVBQUUsYUFBYSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3JELE9BQU8sRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDakQsT0FBTyxFQUFFLGVBQWUsRUFBeUIsVUFBVSxFQUFFLFNBQVMsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ2pHLE9BQU8sRUFBRSxVQUFVLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNqRSxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUd6RSxNQUFNLE9BQU8sb0JBQW9CO0lBRTdCLFlBQ1ksU0FBMkIsRUFDM0IsR0FBc0IsRUFDRixhQUFvQyxFQUN4RCxXQUFpQztRQUhqQyxjQUFTLEdBQVQsU0FBUyxDQUFrQjtRQUMzQixRQUFHLEdBQUgsR0FBRyxDQUFtQjtRQUNGLGtCQUFhLEdBQWIsYUFBYSxDQUF1QjtRQUN4RCxnQkFBVyxHQUFYLFdBQVcsQ0FBc0I7SUFBRyxDQUFDO0lBRTFDLFdBQVcsQ0FBQyxHQUFxQjtRQUNwQyxPQUFPLGFBQWEsQ0FBQztZQUNqQixJQUFJLENBQUMsR0FBRyxFQUFFO1lBQ1YsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJ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Q0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLGFBQWEsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDOUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNSLENBQUM7SUFFTyxPQUFPLENBQUMsR0FBVztRQUN2QixPQUFPLEdBQUcsR0FBRyxHQUFHO2FBQ2YsT0FBTyxDQUFDLDZHQUE2RyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ2hJLENBQUM7OztZQTlEc0IsZ0JBQWdCO1lBQ3RCLGlCQUFpQjs0Q0FDN0IsTUFBTSxTQUFDLFVBQVU7WUFDRyxvQkFBb0I7OztZQVBoRCxVQUFVOzs7WUFSRixnQkFBZ0I7WUFLSixpQkFBaUI7NENBUzdCLE1BQU0sU0FBQyxVQUFVO1lBUmpCLG9CQUFvQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSHR0cEhlYWRlcnMsIEh0dHBSZXF1ZXN0IH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHsgVHJhbnNsYXRlU2VydmljZSB9IGZyb20gJ0BuZ3gtdHJhbnNsYXRlL2NvcmUnO1xuaW1wb3J0IHsgRGF0ZVBpcGUgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YsIGNvbWJpbmVMYXRlc3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHN3aXRjaE1hcCwgdGFrZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IHNpZ25hdHVyZUhlYWRlciwgU2VjdXJpdHlSZXNvdXJjZU1vZGVsLCBPQVVUSF9JTkZPLCBvYXV0aEluZm8gfSBmcm9tICdAZG9uZ2thcC9kby1jb3JlJztcbmltcG9ydCB7IERhdGVGb3JtYXQsIEVuY3J5cHRpb25TZXJ2aWNlIH0gZnJvbSAnQGRvbmdrYXAvZG8tY29yZSc7XG5pbXBvcnQgeyBBdXRoSW5kZXhlZERCU2VydmljZSB9IGZyb20gJy4uL3N0b3JhZ2UvYXV0aC1pbmRleGVkZGIuc2VydmljZSc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBBdXRoU2lnbmF0dXJlU2VydmljZSB7XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSB0cmFuc2xhdGU6IFRyYW5zbGF0ZVNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgZW5jOiBFbmNyeXB0aW9uU2VydmljZSxcbiAgICAgICAgQEluamVjdChPQVVUSF9JTkZPKSBwcml2YXRlIG9hdXRoUmVzb3VyY2U6IFNlY3VyaXR5UmVzb3VyY2VNb2RlbCxcbiAgICAgICAgcHJpdmF0ZSBhdXRoU3RvcmFnZTogQXV0aEluZGV4ZWREQlNlcnZpY2UpIHt9XG5cbiAgICBwdWJsaWMgc2lnbkhlYWRlcnMocmVxOiBIdHRwUmVxdWVzdDxhbnk+KTogT2JzZXJ2YWJsZTxIdHRwUmVxdWVzdDxhbnk+PiB7XG4gICAgICAgIHJldHVybiBjb21iaW5lTGF0ZXN0KFtcbiAgICAgICAgICAgIHRoaXMua2V5KCksXG4gICAgICAgICAgICB0aGlzLnNpZ25hdHVyZSh0aGlzLmdldFBhdGgocmVxLnVybCkpLFxuICAgICAgICBdKS5waXBlKFxuICAgICAgICAgICAgdGFrZSgxKSxcbiAgICAgICAgICAgIHN3aXRjaE1hcCgodmFsdWU6IHN0cmluZ1tdKSA9PiB7XG4gICAgICAgICAgICBpZiAoc2lnbmF0dXJlSGVhZGVyLnNpZ25hdHVyZSkge1xuICAgICAgICAgICAgICAgIGxldCBodHRwSGVhZGVyczogSHR0cEhlYWRlcnMgPSByZXEuaGVhZGVycyA/IHJlcS5oZWFkZXJzIDogbmV3IEh0dHBIZWFkZXJzKCk7XG4gICAgICAgICAgICAgICAgaHR0cEhlYWRlcnMua2V5cygpLmZvckVhY2goKGtleTogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChrZXkgPT09IHNpZ25hdHVyZUhlYWRlci5rZXkpXG4gICAgICAgICAgICAgICAgICAgICAgICBodHRwSGVhZGVycyA9IGh0dHBIZWFkZXJzLmRlbGV0ZShzaWduYXR1cmVIZWFkZXIua2V5KTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGtleSA9PT0gc2lnbmF0dXJlSGVhZGVyLnRpbWVzdGFtcClcbiAgICAgICAgICAgICAgICAgICAgICAgIGh0dHBIZWFkZXJzID0gaHR0cEhlYWRlcnMuZGVsZXRlKHNpZ25hdHVyZUhlYWRlci50aW1lc3RhbXApO1xuICAgICAgICAgICAgICAgICAgICBpZiAoa2V5ID09PSBzaWduYXR1cmVIZWFkZXIuc2lnbmF0dXJlKVxuICAgICAgICAgICAgICAgICAgICAgICAgaHR0cEhlYWRlcnMgPSBodHRwSGVhZGVycy5kZWxldGUoc2lnbmF0dXJlSGVhZGVyLnNpZ25hdHVyZSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgaHR0cEhlYWRlcnMgPSBodHRwSGVhZGVycy5zZXQoc2lnbmF0dXJlSGVhZGVyLmtleSwgdmFsdWVbMF0pO1xuICAgICAgICAgICAgICAgIGh0dHBIZWFkZXJzID0gaHR0cEhlYWRlcnMuc2V0KHNpZ25hdHVyZUhlYWRlci50aW1lc3RhbXAsIHRoaXMudGltZXN0YW1wKCkpO1xuICAgICAgICAgICAgICAgIGh0dHBIZWFkZXJzID0gaHR0cEhlYWRlcnMuc2V0KHNpZ25hdHVyZUhlYWRlci5zaWduYXR1cmUsIHZhbHVlWzFdKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gb2YocmVxLmNsb25lKHsgaGVhZGVyczogaHR0cEhlYWRlcnMgfSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIG9mKHJlcSk7XG4gICAgICAgIH0pKTtcbiAgICB9XG5cbiAgICBwdWJsaWMga2V5KCk6IE9ic2VydmFibGU8c3RyaW5nPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmF1dGhTdG9yYWdlLmdldE9mRW5jKG9hdXRoSW5mby5wdWJsaWNfa2V5KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgdGltZXN0YW1wKCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiBNYXRoLmZsb29yKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC8gMTAwMCkudG9TdHJpbmcoKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZGF0ZSgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gbmV3IERhdGVQaXBlKHRoaXMudHJhbnNsYXRlLmN1cnJlbnRMYW5nKS50cmFuc2Zvcm0obmV3IERhdGUoKSwgRGF0ZUZvcm1hdC5EQVRFKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc2lnbmF0dXJlKHVybDogc3RyaW5nKTogT2JzZXJ2YWJsZTxzdHJpbmc+IHtcbiAgICAgICAgcmV0dXJuIGNvbWJpbmVMYXRlc3QoW1xuICAgICAgICAgICAgdGhpcy5rZXkoKSxcbiAgICAgICAgICAgIHRoaXMuYXV0aFN0b3JhZ2UuZ2V0T2ZFbmMob2F1dGhJbmZvLmFjY2Vzc190b2tlbiksXG4gICAgICAgIF0pLnBpcGUoXG4gICAgICAgICAgICB0YWtlKDEpLFxuICAgICAgICAgICAgc3dpdGNoTWFwKCh2YWx1ZTogc3RyaW5nW10pID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGtleSA9IHZhbHVlWzBdICsgJzonICtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudGltZXN0YW1wKCkgKyAnOicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGhpcy5kYXRlKCkgKyAnOicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgdXJsICsgJzonICtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlWzFdO1xuICAgICAgICAgICAgcmV0dXJuIG9mKHRoaXMuZW5jLmdldEhtYWNTaGEyNTYodGhpcy5vYXV0aFJlc291cmNlWydwcml2YXRlX2tleSddLCBrZXkpKTtcbiAgICAgICAgfSkpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0UGF0aCh1cmw6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiAnLycgKyB1cmxcbiAgICAgICAgLnJlcGxhY2UoL14oaHR0cDpcXC9cXC93d3dcXC58aHR0cHM6XFwvXFwvd3d3XFwufGh0dHA6XFwvXFwvfGh0dHBzOlxcL1xcLyk/W2EtejAtOV0rKFtcXC1cXC5dezF9W2EtejAtOV0rKSooOlswLTldezEsNX0pPyhcXC8pLio/L2csICcnKTtcbiAgICB9XG5cbn1cbiJdfQ==