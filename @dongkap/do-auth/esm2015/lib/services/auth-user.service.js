import { Injectable, Inject } from '@angular/core';
import { Subject } from 'rxjs';
import { map } from 'rxjs/operators';
import { API, HTTP_SERVICE, oauthInfo } from '@dongkap/do-core';
import { UserInfo } from '@dongkap/do-core';
import { ProfileIndexedDBService } from '../storage/profile-indexeddb.service';
import { AuthIndexedDBService } from '../storage/auth-indexeddb.service';
export class AuthUserService extends UserInfo {
    constructor(profileIndexedDB, authIndexedDB, apiPath, httpBaseService) {
        super();
        this.profileIndexedDB = profileIndexedDB;
        this.authIndexedDB = authIndexedDB;
        this.apiPath = apiPath;
        this.httpBaseService = httpBaseService;
        this.loaderUserSubject$ = new Subject();
    }
    loadPhotoUser() {
        Promise.all([
            this.profileIndexedDB.get('image-b64'),
            this.profileIndexedDB.get('image'),
            this.profileIndexedDB.get('name'),
            this.authIndexedDB.getEnc('provider'),
        ]).then((value) => {
            if (!value[0]) {
                if (value[3] === 'local') {
                    if (value[1] && value[2]) {
                        this.getImage(value[1], value[2]);
                    }
                    else {
                        this.httpBaseService.HTTP_AUTH(this.apiPath['profile']['get-profile'])
                            .subscribe((response) => {
                            Promise.all([
                                this.profileIndexedDB.put('name', response['name']),
                                this.profileIndexedDB.put('email', response['email']),
                                this.profileIndexedDB.put('image', response['image']),
                            ]).then(() => {
                                this.getImage(response['image'], response['name']);
                            });
                        });
                    }
                }
                else {
                    const user = {
                        name: value[2],
                        picture: value[1],
                    };
                    this.loaderUserSubject$.next(user);
                }
            }
            else {
                Promise.all([
                    this.profileIndexedDB.get('name'),
                    this.profileIndexedDB.get('image-b64'),
                ]).then((profile) => {
                    const user = {
                        name: profile[0],
                        picture: profile[1],
                    };
                    this.loaderUserSubject$.next(user);
                });
            }
        });
    }
    updatePhotoUser(file, checksum) {
        if (file && checksum) {
            let picture;
            const imageBlob = new Blob([file], {
                type: 'image/png',
            });
            this.profileIndexedDB.put(oauthInfo.image, checksum).then();
            this.profileIndexedDB.put('image-blob', imageBlob).then();
            this.profileIndexedDB.get('name').then((name) => {
                const reader = new FileReader();
                reader.readAsDataURL(imageBlob);
                reader.onloadend = () => {
                    picture = reader.result.toString();
                    const user = {
                        'name': name,
                        'picture': picture,
                    };
                    this.profileIndexedDB.put('image-b64', picture).then();
                    this.loaderUserSubject$.next(user);
                };
            });
        }
        else {
            this.loaderUserSubject$.next(null);
        }
        return this.loaderUserSubject$.asObservable();
    }
    updateNameUser(name) {
        this.profileIndexedDB.put('name', name).then();
        Promise.all([
            this.profileIndexedDB.get('image-b64'),
            this.profileIndexedDB.get('image'),
        ]).then((value) => {
            let picture;
            if (value[0])
                picture = value[0];
            else
                picture = value[1];
            const user = {
                'name': name,
                'picture': picture,
            };
            this.loaderUserSubject$.next(user);
        });
        return this.loaderUserSubject$.asObservable();
    }
    getUser() {
        return this.loaderUserSubject$.asObservable();
    }
    getImage(checksum, name) {
        if (checksum != null) {
            this.httpBaseService.HTTP_AUTH(this.apiPath['file']['vw-photo-profile'], null, null, null, [checksum], 'arraybuffer')
                .pipe(map((response) => {
                let picture;
                const imageBlob = new Blob([response], {
                    type: 'image/png',
                });
                this.profileIndexedDB.put('image-blob', imageBlob).then();
                const reader = new FileReader();
                reader.readAsDataURL(imageBlob);
                reader.onloadend = () => {
                    picture = reader.result.toString();
                    const user = {
                        'name': name,
                        'picture': picture,
                    };
                    this.profileIndexedDB.put('image-b64', picture).then();
                    this.loaderUserSubject$.next(user);
                };
            })).subscribe();
        }
    }
}
AuthUserService.ctorParameters = () => [
    { type: ProfileIndexedDBService },
    { type: AuthIndexedDBService },
    { type: undefined, decorators: [{ type: Inject, args: [API,] }] },
    { type: undefined, decorators: [{ type: Inject, args: [HTTP_SERVICE,] }] }
];
AuthUserService.decorators = [
    { type: Injectable }
];
AuthUserService.ctorParameters = () => [
    { type: ProfileIndexedDBService },
    { type: AuthIndexedDBService },
    { type: undefined, decorators: [{ type: Inject, args: [API,] }] },
    { type: undefined, decorators: [{ type: Inject, args: [HTTP_SERVICE,] }] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aC11c2VyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZG9uZ2thcC9kby1hdXRoLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2VzL2F1dGgtdXNlci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ25ELE9BQU8sRUFBYyxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDM0MsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3JDLE9BQU8sRUFBRSxHQUFHLEVBQVksWUFBWSxFQUFzQixTQUFTLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUM5RixPQUFPLEVBQVEsUUFBUSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDbEQsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFDL0UsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sbUNBQW1DLENBQUM7QUFHekUsTUFBTSxPQUFPLGVBQWdCLFNBQVEsUUFBUTtJQUV6QyxZQUNZLGdCQUF5QyxFQUN6QyxhQUFtQyxFQUN2QixPQUFpQixFQUNSLGVBQW1DO1FBQzVELEtBQUssRUFBRSxDQUFDO1FBSkoscUJBQWdCLEdBQWhCLGdCQUFnQixDQUF5QjtRQUN6QyxrQkFBYSxHQUFiLGFBQWEsQ0FBc0I7UUFDdkIsWUFBTyxHQUFQLE9BQU8sQ0FBVTtRQUNSLG9CQUFlLEdBQWYsZUFBZSxDQUFvQjtRQUc1RCx1QkFBa0IsR0FBRyxJQUFJLE9BQU8sRUFBUSxDQUFDO0lBRGpELENBQUM7SUFHTSxhQUFhO1FBQ2hCLE9BQU8sQ0FBQyxHQUFHLENBQUM7WUFDUixJQUFJLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQztZQUN0QyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQztZQUNsQyxJQUFJLENBQUMsZ0JB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QUksVUFBVSxFQUFFLENBQUM7Z0JBQzVDLE1BQU0sQ0FBQyxhQUFhLENBQUMsU0FBUyxDQUFDLENBQUM7Z0JBQ2hDLE1BQU0sQ0FBQyxTQUFTLEdBQUcsR0FBRyxFQUFFO29CQUNwQixPQUFPLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsQ0FBQztvQkFDbkMsTUFBTSxJQUFJLEdBQVM7d0JBQ2YsTUFBTSxFQUFFLElBQUk7d0JBQ1osU0FBUyxFQUFFLE9BQU87cUJBQ3JCLENBQUM7b0JBQ0YsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUUsT0FBTyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7b0JBQ3ZELElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ3ZDLENBQUMsQ0FBQztZQUNOLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxFQUFFLENBQUM7U0FDbkI7SUFDTCxDQUFDOzs7WUFqSTZCLHVCQUF1QjtZQUMxQixvQkFBb0I7NENBQzFDLE1BQU0sU0FBQyxHQUFHOzRDQUNWLE1BQU0sU0FBQyxZQUFZOzs7WUFQM0IsVUFBVTs7O1lBSEYsdUJBQXVCO1lBQ3ZCLG9CQUFvQjs0Q0FRcEIsTUFBTSxTQUFDLEdBQUc7NENBQ1YsTUFBTSxTQUFDLFlBQVkiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3QgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEFQSSwgQVBJTW9kZWwsIEhUVFBfU0VSVklDRSwgSHR0cEZhY3RvcnlTZXJ2aWNlLCBvYXV0aEluZm8gfSBmcm9tICdAZG9uZ2thcC9kby1jb3JlJztcbmltcG9ydCB7IFVzZXIsIFVzZXJJbmZvIH0gZnJvbSAnQGRvbmdrYXAvZG8tY29yZSc7XG5pbXBvcnQgeyBQcm9maWxlSW5kZXhlZERCU2VydmljZSB9IGZyb20gJy4uL3N0b3JhZ2UvcHJvZmlsZS1pbmRleGVkZGIuc2VydmljZSc7XG5pbXBvcnQgeyBBdXRoSW5kZXhlZERCU2VydmljZSB9IGZyb20gJy4uL3N0b3JhZ2UvYXV0aC1pbmRleGVkZGIuc2VydmljZSc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBBdXRoVXNlclNlcnZpY2UgZXh0ZW5kcyBVc2VySW5mbyB7XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSBwcm9maWxlSW5kZXhlZERCOiBQcm9maWxlSW5kZXhlZERCU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSBhdXRoSW5kZXhlZERCOiBBdXRoSW5kZXhlZERCU2VydmljZSxcbiAgICAgICAgQEluamVjdChBUEkpcHJpdmF0ZSBhcGlQYXRoOiBBUElNb2RlbCxcbiAgICAgICAgQEluamVjdChIVFRQX1NFUlZJQ0UpcHJpdmF0ZSBodHRwQmFzZVNlcnZpY2U6IEh0dHBGYWN0b3J5U2VydmljZSkge1xuICAgICAgICAgICAgc3VwZXIoKTtcbiAgICB9XG4gICAgcHJpdmF0ZSBsb2FkZXJVc2VyU3ViamVjdCQgPSBuZXcgU3ViamVjdDxVc2VyPigpO1xuXG4gICAgcHVibGljIGxvYWRQaG90b1VzZXIoKTogdm9pZCB7XG4gICAgICAgIFByb21pc2UuYWxsKFtcbiAgICAgICAgICAgIHRoaXMucHJvZmlsZUluZGV4ZWREQi5nZXQoJ2ltYWdlLWI2NCcpLFxuICAgICAgICAgICAgdGhpcy5wcm9maWxlSW5kZXhlZERCLmdldCgnaW1hZ2UnKSxcbiAgICAgICAgICAgIHRoaXMucHJvZmlsZUluZGV4ZWREQi5nZXQoJ25hbWUnKSxcbiAgICAgICAgICAgIHRoaXMuYXV0aEluZGV4ZWREQi5nZXRFbmMoJ3Byb3ZpZGVyJyksXG4gICAgICAgIF0pLnRoZW4oKHZhbHVlOiBhbnlbXSkgPT4ge1xuICAgICAgICAgICAgaWYgKCF2YWx1ZVswXSkge1xuICAgICAgICAgICAgICAgIGlmICh2YWx1ZVszXSA9PT0gJ2xvY2FsJykge1xuICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWVbMV0gJiYgdmFsdWVbMl0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2V0SW1hZ2UodmFsdWVbMV0sIHZhbHVlWzJdKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaHR0cEJhc2VTZXJ2aWNlLkhUVFBfQVVUSChcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYXBpUGF0aFsncHJvZmlsZSddWydnZXQtcHJvZmlsZSddKVxuICAgICAgICAgICAgICAgICAgICAgICAgLnN1YnNjcmliZSgocmVzcG9uc2U6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFByb21pc2UuYWxsKFtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wcm9maWxlSW5kZXhlZERCLnB1dCgnbmFtZScsIHJlc3BvbnNlWyduYW1lJ10pLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnByb2ZpbGVJbmRleGVkREIucHV0KCdlbWFpbCcsIHJlc3BvbnNlWydlbWFpbCddKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wcm9maWxlSW5kZXhlZERCLnB1dCgnaW1hZ2UnLCByZXNwb25zZVsnaW1hZ2UnXSksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXSkudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2V0SW1hZ2UocmVzcG9uc2VbJ2ltYWdlJ10sIHJlc3BvbnNlWyduYW1lJ10pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB1c2VyOiBVc2VyID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogdmFsdWVbMl0sXG4gICAgICAgICAgICAgICAgICAgICAgICBwaWN0dXJlOiB2YWx1ZVsxXSxcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2FkZXJVc2VyU3ViamVjdCQubmV4dCh1c2VyKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIFByb21pc2UuYWxsKFtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wcm9maWxlSW5kZXhlZERCLmdldCgnbmFtZScpLFxuICAgICAgICAgICAgICAgICAgICB0aGlzLnByb2ZpbGVJbmRleGVkREIuZ2V0KCdpbWFnZS1iNjQnKSxcbiAgICAgICAgICAgICAgICBdKS50aGVuKChwcm9maWxlOiBhbnlbXSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB1c2VyOiBVc2VyID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogcHJvZmlsZVswXSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHBpY3R1cmU6IHByb2ZpbGVbMV0sXG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubG9hZGVyVXNlclN1YmplY3QkLm5leHQodXNlcik7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyB1cGRhdGVQaG90b1VzZXIoZmlsZTogRmlsZSwgY2hlY2tzdW06IHN0cmluZyk6IE9ic2VydmFibGU8VXNlcj4ge1xuICAgICAgICBpZiAoZmlsZSAmJiBjaGVja3N1bSkge1xuICAgICAgICAgICAgbGV0IHBpY3R1cmU6IHN0cmluZztcbiAgICAgICAgICAgIGNvbnN0IGltYWdlQmxvYiA9IG5ldyBCbG9iKFtmaWxlXSwge1xuICAgICAgICAgICAgICAgIHR5cGU6ICdpbWFnZS9wbmcnLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB0aGlzLnByb2ZpbGVJbmRleGVkREIucHV0KG9hdXRoSW5mby5pbWFnZSwgY2hlY2tzdW0pLnRoZW4oKTtcbiAgICAgICAgICAgIHRoaXMucHJvZmlsZUluZGV4ZWREQi5wdXQoJ2ltYWdlLWJsb2InLCBpbWFnZUJsb2IpLnRoZW4oKTtcbiAgICAgICAgICAgIHRoaXMucHJvZmlsZUluZGV4ZWREQi5nZXQoJ25hbWUnKS50aGVuKChuYW1lOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCByZWFkZXI6IEZpbGVSZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpO1xuICAgICAgICAgICAgICAgIHJlYWRlci5yZWFkQXNEYXRhVVJMKGltYWdlQmxvYik7XG4gICAgICAgICAgICAgICAgcmVhZGVyLm9ubG9hZGVuZCA9ICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcGljdHVyZSA9IHJlYWRlci5yZXN1bHQudG9TdHJpbmcoKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdXNlcjogVXNlciA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICduYW1lJzogbmFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICdwaWN0dXJlJzogcGljdHVyZSxcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wcm9maWxlSW5kZXhlZERCLnB1dCgnaW1hZ2UtYjY0JywgcGljdHVyZSkudGhlbigpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmxvYWRlclVzZXJTdWJqZWN0JC5uZXh0KHVzZXIpO1xuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMubG9hZGVyVXNlclN1YmplY3QkLm5leHQobnVsbCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMubG9hZGVyVXNlclN1YmplY3QkLmFzT2JzZXJ2YWJsZSgpO1xuICAgIH1cblxuICAgIHB1YmxpYyB1cGRhdGVOYW1lVXNlcihuYW1lOiBzdHJpbmcpOiBPYnNlcnZhYmxlPFVzZXI+IHtcbiAgICAgICAgdGhpcy5wcm9maWxlSW5kZXhlZERCLnB1dCgnbmFtZScsIG5hbWUpLnRoZW4oKTtcbiAgICAgICAgUHJvbWlzZS5hbGwoW1xuICAgICAgICAgICAgdGhpcy5wcm9maWxlSW5kZXhlZERCLmdldCgnaW1hZ2UtYjY0JyksXG4gICAgICAgICAgICB0aGlzLnByb2ZpbGVJbmRleGVkREIuZ2V0KCdpbWFnZScpLFxuICAgICAgICBdKS50aGVuKCh2YWx1ZTogYW55W10pID0+IHtcbiAgICAgICAgICAgIGxldCBwaWN0dXJlOiBzdHJpbmc7XG4gICAgICAgICAgICBpZiAodmFsdWVbMF0pXG4gICAgICAgICAgICAgICAgcGljdHVyZSA9IHZhbHVlWzBdO1xuICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgIHBpY3R1cmUgPSB2YWx1ZVsxXTtcbiAgICAgICAgICAgIGNvbnN0IHVzZXI6IFVzZXIgPSB7XG4gICAgICAgICAgICAgICAgJ25hbWUnOiBuYW1lLFxuICAgICAgICAgICAgICAgICdwaWN0dXJlJzogcGljdHVyZSxcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB0aGlzLmxvYWRlclVzZXJTdWJqZWN0JC5uZXh0KHVzZXIpO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHRoaXMubG9hZGVyVXNlclN1YmplY3QkLmFzT2JzZXJ2YWJsZSgpO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRVc2VyKCk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmxvYWRlclVzZXJTdWJqZWN0JC5hc09ic2VydmFibGUoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldEltYWdlKGNoZWNrc3VtOiBhbnksIG5hbWU6IHN0cmluZykge1xuICAgICAgICBpZiAoY2hlY2tzdW0gIT0gbnVsbCkge1xuICAgICAgICAgICAgdGhpcy5odHRwQmFzZVNlcnZpY2UuSFRUUF9BVVRIKFxuICAgICAgICAgICAgdGhpcy5hcGlQYXRoWydmaWxlJ11bJ3Z3LXBob3RvLXByb2ZpbGUnXSwgbnVsbCwgbnVsbCwgbnVsbCxcbiAgICAgICAgICAgIFtjaGVja3N1bV0sICdhcnJheWJ1ZmZlcicpXG4gICAgICAgICAgICAucGlwZShtYXAoKHJlc3BvbnNlOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgcGljdHVyZTogc3RyaW5nO1xuICAgICAgICAgICAgICAgIGNvbnN0IGltYWdlQmxvYiA9IG5ldyBCbG9iKFtyZXNwb25zZV0sIHtcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2ltYWdlL3BuZycsXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgdGhpcy5wcm9maWxlSW5kZXhlZERCLnB1dCgnaW1hZ2UtYmxvYicsIGltYWdlQmxvYikudGhlbigpO1xuICAgICAgICAgICAgICAgIGNvbnN0IHJlYWRlcjogRmlsZVJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7XG4gICAgICAgICAgICAgICAgcmVhZGVyLnJlYWRBc0RhdGFVUkwoaW1hZ2VCbG9iKTtcbiAgICAgICAgICAgICAgICByZWFkZXIub25sb2FkZW5kID0gKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBwaWN0dXJlID0gcmVhZGVyLnJlc3VsdC50b1N0cmluZygpO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB1c2VyOiBVc2VyID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgJ25hbWUnOiBuYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgJ3BpY3R1cmUnOiBwaWN0dXJlLFxuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnByb2ZpbGVJbmRleGVkREIucHV0KCdpbWFnZS1iNjQnLCBwaWN0dXJlKS50aGVuKCk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubG9hZGVyVXNlclN1YmplY3QkLm5leHQodXNlcik7XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH0pKS5zdWJzY3JpYmUoKTtcbiAgICAgICAgfVxuICAgIH1cblxufVxuIl19