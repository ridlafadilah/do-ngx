import { __extends } from "tslib";
import { Injectable, Inject } from '@angular/core';
import { Subject } from 'rxjs';
import { map } from 'rxjs/operators';
import { API, HTTP_SERVICE, oauthInfo } from '@dongkap/do-core';
import { UserInfo } from '@dongkap/do-core';
import { ProfileIndexedDBService } from '../storage/profile-indexeddb.service';
import { AuthIndexedDBService } from '../storage/auth-indexeddb.service';
var AuthUserService = /** @class */ (function (_super) {
    __extends(AuthUserService, _super);
    function AuthUserService(profileIndexedDB, authIndexedDB, apiPath, httpBaseService) {
        var _this = _super.call(this) || this;
        _this.profileIndexedDB = profileIndexedDB;
        _this.authIndexedDB = authIndexedDB;
        _this.apiPath = apiPath;
        _this.httpBaseService = httpBaseService;
        _this.loaderUserSubject$ = new Subject();
        return _this;
    }
    AuthUserService.prototype.loadPhotoUser = function () {
        var _this = this;
        Promise.all([
            this.profileIndexedDB.get('image-b64'),
            this.profileIndexedDB.get('image'),
            this.profileIndexedDB.get('name'),
            this.authIndexedDB.getEnc('provider'),
        ]).then(function (value) {
            if (!value[0]) {
                if (value[3] === 'local') {
                    if (value[1] && value[2]) {
                        _this.getImage(value[1], value[2]);
                    }
                    else {
                        _this.httpBaseService.HTTP_AUTH(_this.apiPath['profile']['get-profile'])
                            .subscribe(function (response) {
                            Promise.all([
                                _this.profileIndexedDB.put('name', response['name']),
                                _this.profileIndexedDB.put('email', response['email']),
                                _this.profileIndexedDB.put('image', response['image']),
                            ]).then(function () {
                                _this.getImage(response['image'], response['name']);
                            });
                        });
                    }
                }
                else {
                    var user = {
                        name: value[2],
                        picture: value[1],
                    };
                    _this.loaderUserSubject$.next(user);
                }
            }
            else {
                Promise.all([
                    _this.profileIndexedDB.get('name'),
                    _this.profileIndexedDB.get('image-b64'),
                ]).then(function (profile) {
                    var user = {
                        name: profile[0],
                        picture: profile[1],
                    };
                    _this.loaderUserSubject$.next(user);
                });
            }
        });
    };
    AuthUserService.prototype.updatePhotoUser = function (file, checksum) {
        var _this = this;
        if (file && checksum) {
            var picture_1;
            var imageBlob_1 = new Blob([file], {
                type: 'image/png',
            });
            this.profileIndexedDB.put(oauthInfo.image, checksum).then();
            this.profileIndexedDB.put('image-blob', imageBlob_1).then();
            this.profileIndexedDB.get('name').then(function (name) {
                var reader = new FileReader();
                reader.readAsDataURL(imageBlob_1);
                reader.onloadend = function () {
                    picture_1 = reader.result.toString();
                    var user = {
                        'name': name,
                        'picture': picture_1,
                    };
                    _this.profileIndexedDB.put('image-b64', picture_1).then();
                    _this.loaderUserSubject$.next(user);
                };
            });
        }
        else {
            this.loaderUserSubject$.next(null);
        }
        return this.loaderUserSubject$.asObservable();
    };
    AuthUserService.prototype.updateNameUser = function (name) {
        var _this = this;
        this.profileIndexedDB.put('name', name).then();
        Promise.all([
            this.profileIndexedDB.get('image-b64'),
            this.profileIndexedDB.get('image'),
        ]).then(function (value) {
            var picture;
            if (value[0])
                picture = value[0];
            else
                picture = value[1];
            var user = {
                'name': name,
                'picture': picture,
            };
            _this.loaderUserSubject$.next(user);
        });
        return this.loaderUserSubject$.asObservable();
    };
    AuthUserService.prototype.getUser = function () {
        return this.loaderUserSubject$.asObservable();
    };
    AuthUserService.prototype.getImage = function (checksum, name) {
        var _this = this;
        if (checksum != null) {
            this.httpBaseService.HTTP_AUTH(this.apiPath['file']['vw-photo-profile'], null, null, null, [checksum], 'arraybuffer')
                .pipe(map(function (response) {
                var picture;
                var imageBlob = new Blob([response], {
                    type: 'image/png',
                });
                _this.profileIndexedDB.put('image-blob', imageBlob).then();
                var reader = new FileReader();
                reader.readAsDataURL(imageBlob);
                reader.onloadend = function () {
                    picture = reader.result.toString();
                    var user = {
                        'name': name,
                        'picture': picture,
                    };
                    _this.profileIndexedDB.put('image-b64', picture).then();
                    _this.loaderUserSubject$.next(user);
                };
            })).subscribe();
        }
    };
    AuthUserService.ctorParameters = function () { return [
        { type: ProfileIndexedDBService },
        { type: AuthIndexedDBService },
        { type: undefined, decorators: [{ type: Inject, args: [API,] }] },
        { type: undefined, decorators: [{ type: Inject, args: [HTTP_SERVICE,] }] }
    ]; };
    AuthUserService.decorators = [
        { type: Injectable }
    ];
    AuthUserService.ctorParameters = function () { return [
        { type: ProfileIndexedDBService },
        { type: AuthIndexedDBService },
        { type: undefined, decorators: [{ type: Inject, args: [API,] }] },
        { type: undefined, decorators: [{ type: Inject, args: [HTTP_SERVICE,] }] }
    ]; };
    return AuthUserService;
}(UserInfo));
export { AuthUserService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aC11c2VyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZG9uZ2thcC9kby1hdXRoLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2VzL2F1dGgtdXNlci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNuRCxPQUFPLEVBQWMsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNyQyxPQUFPLEVBQUUsR0FBRyxFQUFZLFlBQVksRUFBc0IsU0FBUyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDOUYsT0FBTyxFQUFRLFFBQVEsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ2xELE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxNQUFNLHNDQUFzQyxDQUFDO0FBQy9FLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLG1DQUFtQyxDQUFDO0FBRXpFO0lBQ3FDLG1DQUFRO0lBRXpDLHlCQUNZLGdCQUF5QyxFQUN6QyxhQUFtQyxFQUN2QixPQUFpQixFQUNSLGVBQW1DO1FBSnBFLFlBS1EsaUJBQU8sU0FDZDtRQUxXLHNCQUFnQixHQUFoQixnQkFBZ0IsQ0FBeUI7UUFDekMsbUJBQWEsR0FBYixhQUFhLENBQXNCO1FBQ3ZCLGFBQU8sR0FBUCxPQUFPLENBQVU7UUFDUixxQkFBZSxHQUFmLGVBQWUsQ0FBb0I7UUFHNUQsd0JBQWtCLEdBQUcsSUFBSSxPQUFPLEVBQVEsQ0FBQzs7SUFEakQsQ0FBQztJQUdNLHVDQUFhLEdBQXBCO1FBQUEsaUJBNENDO1FBM0NHLE9BQU8sQ0FBQyxHQUFHLENBQUM7WUFDUixJQUFJLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQztZQUN0QyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQztZQUNsQyxJQUFJ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VUFBVSxFQUFFLENBQUM7Z0JBQzVDLE1BQU0sQ0FBQyxhQUFhLENBQUMsU0FBUyxDQUFDLENBQUM7Z0JBQ2hDLE1BQU0sQ0FBQyxTQUFTLEdBQUc7b0JBQ2YsT0FBTyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLENBQUM7b0JBQ25DLElBQU0sSUFBSSxHQUFTO3dCQUNmLE1BQU0sRUFBRSxJQUFJO3dCQUNaLFNBQVMsRUFBRSxPQUFPO3FCQUNyQixDQUFDO29CQUNGLEtBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFLE9BQU8sQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO29CQUN2RCxLQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUN2QyxDQUFDLENBQUM7WUFDTixDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsRUFBRSxDQUFDO1NBQ25CO0lBQ0wsQ0FBQzs7Z0JBakk2Qix1QkFBdUI7Z0JBQzFCLG9CQUFvQjtnREFDMUMsTUFBTSxTQUFDLEdBQUc7Z0RBQ1YsTUFBTSxTQUFDLFlBQVk7OztnQkFQM0IsVUFBVTs7O2dCQUhGLHVCQUF1QjtnQkFDdkIsb0JBQW9CO2dEQVFwQixNQUFNLFNBQUMsR0FBRztnREFDVixNQUFNLFNBQUMsWUFBWTs7SUFnSTVCLHNCQUFDO0NBQUEsQUF2SUQsQ0FDcUMsUUFBUSxHQXNJNUM7U0F0SVksZUFBZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgQVBJLCBBUElNb2RlbCwgSFRUUF9TRVJWSUNFLCBIdHRwRmFjdG9yeVNlcnZpY2UsIG9hdXRoSW5mbyB9IGZyb20gJ0Bkb25na2FwL2RvLWNvcmUnO1xuaW1wb3J0IHsgVXNlciwgVXNlckluZm8gfSBmcm9tICdAZG9uZ2thcC9kby1jb3JlJztcbmltcG9ydCB7IFByb2ZpbGVJbmRleGVkREJTZXJ2aWNlIH0gZnJvbSAnLi4vc3RvcmFnZS9wcm9maWxlLWluZGV4ZWRkYi5zZXJ2aWNlJztcbmltcG9ydCB7IEF1dGhJbmRleGVkREJTZXJ2aWNlIH0gZnJvbSAnLi4vc3RvcmFnZS9hdXRoLWluZGV4ZWRkYi5zZXJ2aWNlJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEF1dGhVc2VyU2VydmljZSBleHRlbmRzIFVzZXJJbmZvIHtcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwcml2YXRlIHByb2ZpbGVJbmRleGVkREI6IFByb2ZpbGVJbmRleGVkREJTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIGF1dGhJbmRleGVkREI6IEF1dGhJbmRleGVkREJTZXJ2aWNlLFxuICAgICAgICBASW5qZWN0KEFQSSlwcml2YXRlIGFwaVBhdGg6IEFQSU1vZGVsLFxuICAgICAgICBASW5qZWN0KEhUVFBfU0VSVklDRSlwcml2YXRlIGh0dHBCYXNlU2VydmljZTogSHR0cEZhY3RvcnlTZXJ2aWNlKSB7XG4gICAgICAgICAgICBzdXBlcigpO1xuICAgIH1cbiAgICBwcml2YXRlIGxvYWRlclVzZXJTdWJqZWN0JCA9IG5ldyBTdWJqZWN0PFVzZXI+KCk7XG5cbiAgICBwdWJsaWMgbG9hZFBob3RvVXNlcigpOiB2b2lkIHtcbiAgICAgICAgUHJvbWlzZS5hbGwoW1xuICAgICAgICAgICAgdGhpcy5wcm9maWxlSW5kZXhlZERCLmdldCgnaW1hZ2UtYjY0JyksXG4gICAgICAgICAgICB0aGlzLnByb2ZpbGVJbmRleGVkREIuZ2V0KCdpbWFnZScpLFxuICAgICAgICAgICAgdGhpcy5wcm9maWxlSW5kZXhlZERCLmdldCgnbmFtZScpLFxuICAgICAgICAgICAgdGhpcy5hdXRoSW5kZXhlZERCLmdldEVuYygncHJvdmlkZXInKSxcbiAgICAgICAgXSkudGhlbigodmFsdWU6IGFueVtdKSA9PiB7XG4gICAgICAgICAgICBpZiAoIXZhbHVlWzBdKSB7XG4gICAgICAgICAgICAgICAgaWYgKHZhbHVlWzNdID09PSAnbG9jYWwnKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZVsxXSAmJiB2YWx1ZVsyXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXRJbWFnZSh2YWx1ZVsxXSwgdmFsdWVbMl0pO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5odHRwQmFzZVNlcnZpY2UuSFRUUF9BVVRIKFxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hcGlQYXRoWydwcm9maWxlJ11bJ2dldC1wcm9maWxlJ10pXG4gICAgICAgICAgICAgICAgICAgICAgICAuc3Vic2NyaWJlKChyZXNwb25zZTogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgUHJvbWlzZS5hbGwoW1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnByb2ZpbGVJbmRleGVkREIucHV0KCduYW1lJywgcmVzcG9uc2VbJ25hbWUnXSksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHJvZmlsZUluZGV4ZWREQi5wdXQoJ2VtYWlsJywgcmVzcG9uc2VbJ2VtYWlsJ10pLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnByb2ZpbGVJbmRleGVkREIucHV0KCdpbWFnZScsIHJlc3BvbnNlWydpbWFnZSddKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBdKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXRJbWFnZShyZXNwb25zZVsnaW1hZ2UnXSwgcmVzcG9uc2VbJ25hbWUnXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHVzZXI6IFVzZXIgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiB2YWx1ZVsyXSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHBpY3R1cmU6IHZhbHVlWzFdLFxuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmxvYWRlclVzZXJTdWJqZWN0JC5uZXh0KHVzZXIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgUHJvbWlzZS5hbGwoW1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnByb2ZpbGVJbmRleGVkREIuZ2V0KCduYW1lJyksXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucHJvZmlsZUluZGV4ZWREQi5nZXQoJ2ltYWdlLWI2NCcpLFxuICAgICAgICAgICAgICAgIF0pLnRoZW4oKHByb2ZpbGU6IGFueVtdKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHVzZXI6IFVzZXIgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBwcm9maWxlWzBdLFxuICAgICAgICAgICAgICAgICAgICAgICAgcGljdHVyZTogcHJvZmlsZVsxXSxcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2FkZXJVc2VyU3ViamVjdCQubmV4dCh1c2VyKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIHVwZGF0ZVBob3RvVXNlcihmaWxlOiBGaWxlLCBjaGVja3N1bTogc3RyaW5nKTogT2JzZXJ2YWJsZTxVc2VyPiB7XG4gICAgICAgIGlmIChmaWxlICYmIGNoZWNrc3VtKSB7XG4gICAgICAgICAgICBsZXQgcGljdHVyZTogc3RyaW5nO1xuICAgICAgICAgICAgY29uc3QgaW1hZ2VCbG9iID0gbmV3IEJsb2IoW2ZpbGVdLCB7XG4gICAgICAgICAgICAgICAgdHlwZTogJ2ltYWdlL3BuZycsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHRoaXMucHJvZmlsZUluZGV4ZWREQi5wdXQob2F1dGhJbmZvLmltYWdlLCBjaGVja3N1bSkudGhlbigpO1xuICAgICAgICAgICAgdGhpcy5wcm9maWxlSW5kZXhlZERCLnB1dCgnaW1hZ2UtYmxvYicsIGltYWdlQmxvYikudGhlbigpO1xuICAgICAgICAgICAgdGhpcy5wcm9maWxlSW5kZXhlZERCLmdldCgnbmFtZScpLnRoZW4oKG5hbWU6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHJlYWRlcjogRmlsZVJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7XG4gICAgICAgICAgICAgICAgcmVhZGVyLnJlYWRBc0RhdGFVUkwoaW1hZ2VCbG9iKTtcbiAgICAgICAgICAgICAgICByZWFkZXIub25sb2FkZW5kID0gKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBwaWN0dXJlID0gcmVhZGVyLnJlc3VsdC50b1N0cmluZygpO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB1c2VyOiBVc2VyID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgJ25hbWUnOiBuYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgJ3BpY3R1cmUnOiBwaWN0dXJlLFxuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnByb2ZpbGVJbmRleGVkREIucHV0KCdpbWFnZS1iNjQnLCBwaWN0dXJlKS50aGVuKCk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubG9hZGVyVXNlclN1YmplY3QkLm5leHQodXNlcik7XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5sb2FkZXJVc2VyU3ViamVjdCQubmV4dChudWxsKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5sb2FkZXJVc2VyU3ViamVjdCQuYXNPYnNlcnZhYmxlKCk7XG4gICAgfVxuXG4gICAgcHVibGljIHVwZGF0ZU5hbWVVc2VyKG5hbWU6IHN0cmluZyk6IE9ic2VydmFibGU8VXNlcj4ge1xuICAgICAgICB0aGlzLnByb2ZpbGVJbmRleGVkREIucHV0KCduYW1lJywgbmFtZSkudGhlbigpO1xuICAgICAgICBQcm9taXNlLmFsbChbXG4gICAgICAgICAgICB0aGlzLnByb2ZpbGVJbmRleGVkREIuZ2V0KCdpbWFnZS1iNjQnKSxcbiAgICAgICAgICAgIHRoaXMucHJvZmlsZUluZGV4ZWREQi5nZXQoJ2ltYWdlJyksXG4gICAgICAgIF0pLnRoZW4oKHZhbHVlOiBhbnlbXSkgPT4ge1xuICAgICAgICAgICAgbGV0IHBpY3R1cmU6IHN0cmluZztcbiAgICAgICAgICAgIGlmICh2YWx1ZVswXSlcbiAgICAgICAgICAgICAgICBwaWN0dXJlID0gdmFsdWVbMF07XG4gICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgcGljdHVyZSA9IHZhbHVlWzFdO1xuICAgICAgICAgICAgY29uc3QgdXNlcjogVXNlciA9IHtcbiAgICAgICAgICAgICAgICAnbmFtZSc6IG5hbWUsXG4gICAgICAgICAgICAgICAgJ3BpY3R1cmUnOiBwaWN0dXJlLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHRoaXMubG9hZGVyVXNlclN1YmplY3QkLm5leHQodXNlcik7XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gdGhpcy5sb2FkZXJVc2VyU3ViamVjdCQuYXNPYnNlcnZhYmxlKCk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldFVzZXIoKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMubG9hZGVyVXNlclN1YmplY3QkLmFzT2JzZXJ2YWJsZSgpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0SW1hZ2UoY2hlY2tzdW06IGFueSwgbmFtZTogc3RyaW5nKSB7XG4gICAgICAgIGlmIChjaGVja3N1bSAhPSBudWxsKSB7XG4gICAgICAgICAgICB0aGlzLmh0dHBCYXNlU2VydmljZS5IVFRQX0FVVEgoXG4gICAgICAgICAgICB0aGlzLmFwaVBhdGhbJ2ZpbGUnXVsndnctcGhvdG8tcHJvZmlsZSddLCBudWxsLCBudWxsLCBudWxsLFxuICAgICAgICAgICAgW2NoZWNrc3VtXSwgJ2FycmF5YnVmZmVyJylcbiAgICAgICAgICAgIC5waXBlKG1hcCgocmVzcG9uc2U6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBwaWN0dXJlOiBzdHJpbmc7XG4gICAgICAgICAgICAgICAgY29uc3QgaW1hZ2VCbG9iID0gbmV3IEJsb2IoW3Jlc3BvbnNlXSwge1xuICAgICAgICAgICAgICAgICAgICB0eXBlOiAnaW1hZ2UvcG5nJyxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB0aGlzLnByb2ZpbGVJbmRleGVkREIucHV0KCdpbWFnZS1ibG9iJywgaW1hZ2VCbG9iKS50aGVuKCk7XG4gICAgICAgICAgICAgICAgY29uc3QgcmVhZGVyOiBGaWxlUmVhZGVyID0gbmV3IEZpbGVSZWFkZXIoKTtcbiAgICAgICAgICAgICAgICByZWFkZXIucmVhZEFzRGF0YVVSTChpbWFnZUJsb2IpO1xuICAgICAgICAgICAgICAgIHJlYWRlci5vbmxvYWRlbmQgPSAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHBpY3R1cmUgPSByZWFkZXIucmVzdWx0LnRvU3RyaW5nKCk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHVzZXI6IFVzZXIgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAnbmFtZSc6IG5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAncGljdHVyZSc6IHBpY3R1cmUsXG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucHJvZmlsZUluZGV4ZWREQi5wdXQoJ2ltYWdlLWI2NCcsIHBpY3R1cmUpLnRoZW4oKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2FkZXJVc2VyU3ViamVjdCQubmV4dCh1c2VyKTtcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfSkpLnN1YnNjcmliZSgpO1xuICAgICAgICB9XG4gICAgfVxuXG59XG4iXX0=