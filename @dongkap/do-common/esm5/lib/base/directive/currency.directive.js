import { __read } from "tslib";
import { Directive, HostListener, Input, ElementRef } from '@angular/core';
import { NgControl } from '@angular/forms';
var CurrencyMaskDirective = /** @class */ (function () {
    function CurrencyMaskDirective(ngControl, el) {
        this.ngControl = ngControl;
        this.el = el;
        this.prefix = 'Rp';
        this.decimalSeparator = '.';
        this.thousandsSeparator = ',';
        this.suffix = ',-';
        this.padding = 5;
    }
    CurrencyMaskDirective.prototype.onFocus = function (value, event) {
        value = value ? value : this.prefix.concat(' ');
        value = this.onLeave(value.replace(this.suffix, ''));
        event.target.toNumber = this.toNumber(value);
        this.ngControl.valueAccessor.writeValue(value);
    };
    CurrencyMaskDirective.prototype.onBlur = function (value, event) {
        value = value.replace(/\D/g, '') ? this.onLeave(value).concat(this.suffix) : '';
        event.target.toNumber = this.toNumber(value);
        this.ngControl.valueAccessor.writeValue(value);
    };
    CurrencyMaskDirective.prototype.onModelChange = function (value) {
        value = this.toNumber(value);
        value = value.replace(new RegExp('[^0-9|^' + this.decimalSeparator + '|^-]', 'g'), '');
        if (value.toString().match(new RegExp('^\-?[0-9]*(' + this.decimalSeparator + '[0-9]*)?$', 'g'))) {
            var _a = this.onInputChange(value), val = _a.val, frac = _a.frac;
            if (value.toString().match(new RegExp('^\-?[0-9]*$', 'g'))) {
                val = (!isNaN(parseInt(val, 10)) && val !== '-0') ? parseInt(val, 10).toString() : val;
                value = this.onTransform(val, frac);
                this.value = this.prefix.concat(' ').concat(value);
            }
            if (value.toString().match(new RegExp('^(\-?[0-9])*[' + this.decimalSeparator + '][0-9]*$', 'g')) &&
                !value.toString().startsWith(this.decimalSeparator, 0)) {
                frac = frac.substring(0, this.padding);
                frac = this.decimalSeparator.concat(frac);
                value = this.onTransform(val, frac);
                this.value = this.prefix.concat(' ').concat(value);
            }
            this.el.nativeElement.toNumber = this.toNumber(this.prefix.concat(' ').concat(this.onTransform(val, (parseInt(frac.replace(this.decimalSeparator, ''), 10) > 0) ?
                this.pad(frac, this.padding + 1).substring(0, this.padding + 1) :
                '')));
        }
        this.ngControl.valueAccessor.writeValue(this.value);
    };
    CurrencyMaskDirective.prototype.onKeyDown = function (event) {
        if (event.key) {
            if (['DELETE', 'BACKSPACE', 'TAB', 'ESCAPE',
                'ENTER', 'DECIMAL POINT', 'PERIOD', 'DASH'].indexOf(event.key.toUpperCase()) !== -1 ||
                (event.key.toUpperCase() === 'A' && event.ctrlKey === true) || // Allow: Ctrl+A
                (event.key.toUpperCase() === 'C' && event.ctrlKey === true) || // Allow: Ctrl+C
                (event.key.toUpperCase() === 'V' && event.ctrlKey === true) || // Allow: Ctrl+V
                (event.key.toUpperCase() === 'X' && event.ctrlKey === true) || // Allow: Ctrl+X
                (event.key.toUpperCase() === 'A' && event.metaKey === true) || // Cmd+A (Mac)
                (event.key.toUpperCase() === 'C' && event.metaKey === true) || // Cmd+C (Mac)
                (event.key.toUpperCase() === 'V' && event.metaKey === true) || // Cmd+V (Mac)
                (event.key.toUpperCase() === 'X' && event.metaKey === true) || // Cmd+X (Mac)
                (event.key.toUpperCase() === 'END') ||
                (event.key.toUpperCase() === 'HOME') ||
                (event.key.toUpperCase() === 'ARROWLEFT') ||
                (event.key.toUpperCase() === 'ARROWRIGHT') || (event.key.match(/[0-9.,\-]/g))) {
                return; // let it happen, don't do anything
            }
        }
        // Ensure that it is a number and stop the keypress
        /*
        if ((event.shiftKey || (event.key.match(/[0-9.,\-+]/g)))) {
            event.preventDefault();
        }
        */
    };
    CurrencyMaskDirective.prototype.onLeave = function (value) {
        var _a = this.onInputChange(value), val = _a.val, frac = _a.frac;
        var fraction = '';
        if (frac) {
            if (parseInt(frac, 10) > 0) {
                fraction = this.decimalSeparator + this.pad(frac, this.padding).substring(0, this.padding);
            }
        }
        return this.onTransform(val, fraction);
    };
    CurrencyMaskDirective.prototype.onInputChange = function (value) {
        var _a = __read((value || '').split(this.decimalSeparator), 2), _b = _a[0], val = _b === void 0 ? '' : _b, _c = _a[1], fraction = _c === void 0 ? '' : _c;
        return { val: val, frac: fraction };
    };
    CurrencyMaskDirective.prototype.onTransform = function (val, fraction) {
        val = val.replace(/\B(?=(\d{3})+(?!\d))/g, this.thousandsSeparator);
        return val + fraction;
    };
    CurrencyMaskDirective.prototype.toNumber = function (val) {
        return val
            .replace(this.prefix, '')
            .replace(' ', '')
            .replace(this.suffix, '')
            .replace(new RegExp(this.thousandsSeparator, 'g'), '');
    };
    CurrencyMaskDirective.prototype.pad = function (val, size) {
        while (val.length < size)
            val = val + '0';
        return val;
    };
    CurrencyMaskDirective.ctorParameters = function () { return [
        { type: NgControl },
        { type: ElementRef }
    ]; };
    CurrencyMaskDirective.decorators = [
        { type: Directive, args: [{
                    selector: 'input[doCurrency]',
                },] }
    ];
    CurrencyMaskDirective.ctorParameters = function () { return [
        { type: NgControl },
        { type: ElementRef }
    ]; };
    CurrencyMaskDirective.propDecorators = {
        prefix: [{ type: Input, args: ['prefix',] }],
        decimalSeparator: [{ type: Input, args: ['decimal',] }],
        thousandsSeparator: [{ type: Input, args: ['thousand',] }],
        suffix: [{ type: Input, args: ['suffix',] }],
        padding: [{ type: Input, args: ['padding',] }],
        onFocus: [{ type: HostListener, args: ['focus', ['$event.target.value', '$event'],] }],
        onBlur: [{ type: HostListener, args: ['blur', ['$event.target.value', '$event'],] }],
        onModelChange: [{ type: HostListener, args: ['ngModelChange', ['$event'],] }],
        onKeyDown: [{ type: HostListener, args: ['keydown', ['$event'],] }]
    };
    return CurrencyMaskDirective;
}());
export { CurrencyMaskDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3VycmVuY3kuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGRvbmdrYXAvZG8tY29tbW9uLyIsInNvdXJjZXMiOlsibGliL2Jhc2UvZGlyZWN0aXZlL2N1cnJlbmN5LmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzRSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFM0M7SUFXSSwrQkFBb0IsU0FBb0IsRUFBVSxFQUFjO1FBQTVDLGNBQVMsR0FBVCxTQUFTLENBQVc7UUFBVSxPQUFFLEdBQUYsRUFBRSxDQUFZO1FBUC9DLFdBQU0sR0FBVyxJQUFJLENBQUM7UUFDckIscUJBQWdCLEdBQVcsR0FBRyxDQUFDO1FBQzlCLHVCQUFrQixHQUFXLEdBQUcsQ0FBQztRQUNuQyxXQUFNLEdBQVcsSUFBSSxDQUFDO1FBQ3JCLFlBQU8sR0FBVyxDQUFDLENBQUM7SUFHOEIsQ0FBQztJQUdyRSx1Q0FBTyxHQURQLFVBQ1EsS0FBSyxFQUFFLEtBQUs7UUFDaEIsS0FBSyxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNoRCxLQUFLLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUNyRCxLQUFLLENBQUMsTUFBTSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzdDLElBQUksQ0FBQyxTQUFTLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNuRCxDQUFDO0lBR0Qsc0NBQU0sR0FETixV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QUFFLEVBQUUsQ0FBQzthQUNoQixPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUM7YUFDeEIsT0FBTyxDQUFDLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxHQUFHLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUMvRCxDQUFDO0lBRU8sbUNBQUcsR0FBWCxVQUFZLEdBQUcsRUFBRSxJQUFJO1FBQ2pCLE9BQU8sR0FBRyxDQUFDLE1BQU0sR0FBRyxJQUFJO1lBQUUsR0FBRyxHQUFHLEdBQUcsR0FBRyxHQUFHLENBQUM7UUFDMUMsT0FBTyxHQUFHLENBQUM7SUFDZixDQUFDOztnQkE1RzhCLFNBQVM7Z0JBQWMsVUFBVTs7O2dCQVhuRSxTQUFTLFNBQUM7b0JBQ1AsUUFBUSxFQUFFLG1CQUFtQjtpQkFDaEM7OztnQkFKUSxTQUFTO2dCQUR1QixVQUFVOzs7eUJBTzlDLEtBQUssU0FBQyxRQUFRO21DQUNkLEtBQUssU0FBQyxTQUFTO3FDQUNmLEtBQUssU0FBQyxVQUFVO3lCQUNoQixLQUFLLFNBQUMsUUFBUTswQkFDZCxLQUFLLFNBQUMsU0FBUzswQkFLZixZQUFZLFNBQUMsT0FBTyxFQUFFLENBQUMscUJBQXFCLEVBQUUsUUFBUSxDQUFDO3lCQVF2RCxZQUFZLFNBQUMsTUFBTSxFQUFFLENBQUMscUJBQXFCLEVBQUUsUUFBUSxDQUFDO2dDQU90RCxZQUFZLFNBQUMsZUFBZSxFQUFFLENBQUMsUUFBUSxDQUFDOzRCQTRCeEMsWUFBWSxTQUFDLFNBQVMsRUFBRSxDQUFDLFFBQVEsQ0FBQzs7SUFnRXZDLDRCQUFDO0NBQUEsQUF4SEQsSUF3SEM7U0FySFkscUJBQXFCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGlyZWN0aXZlLCBIb3N0TGlzdGVuZXIsIElucHV0LCBFbGVtZW50UmVmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBOZ0NvbnRyb2wgfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XG5cbkBEaXJlY3RpdmUoe1xuICAgIHNlbGVjdG9yOiAnaW5wdXRbZG9DdXJyZW5jeV0nLFxufSlcbmV4cG9ydCBjbGFzcyBDdXJyZW5jeU1hc2tEaXJlY3RpdmUge1xuICAgIEBJbnB1dCgncHJlZml4JykgcHJlZml4OiBzdHJpbmcgPSAnUnAnO1xuICAgIEBJbnB1dCgnZGVjaW1hbCcpIGRlY2ltYWxTZXBhcmF0b3I6IHN0cmluZyA9ICcuJztcbiAgICBASW5wdXQoJ3Rob3VzYW5kJykgdGhvdXNhbmRzU2VwYXJhdG9yOiBzdHJpbmcgPSAnLCc7XG4gICAgQElucHV0KCdzdWZmaXgnKSBzdWZmaXg6IHN0cmluZyA9ICcsLSc7XG4gICAgQElucHV0KCdwYWRkaW5nJykgcGFkZGluZzogbnVtYmVyID0gNTtcbiAgICBwcml2YXRlIHZhbHVlOiBzdHJpbmc7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIG5nQ29udHJvbDogTmdDb250cm9sLCBwcml2YXRlIGVsOiBFbGVtZW50UmVmKSB7IH1cblxuICAgIEBIb3N0TGlzdGVuZXIoJ2ZvY3VzJywgWyckZXZlbnQudGFyZ2V0LnZhbHVlJywgJyRldmVudCddKVxuICAgIG9uRm9jdXModmFsdWUsIGV2ZW50KSB7XG4gICAgICAgIHZhbHVlID0gdmFsdWUgPyB2YWx1ZSA6IHRoaXMucHJlZml4LmNvbmNhdCgnICcpO1xuICAgICAgICB2YWx1ZSA9IHRoaXMub25MZWF2ZSh2YWx1ZS5yZXBsYWNlKHRoaXMuc3VmZml4LCAnJykpO1xuICAgICAgICBldmVudC50YXJnZXQudG9OdW1iZXIgPSB0aGlzLnRvTnVtYmVyKHZhbHVlKTtcbiAgICAgICAgdGhpcy5uZ0NvbnRyb2wudmFsdWVBY2Nlc3Nvci53cml0ZVZhbHVlKHZhbHVlKTtcbiAgICB9XG5cbiAgICBASG9zdExpc3RlbmVyKCdibHVyJywgWyckZXZlbnQudGFyZ2V0LnZhbHVlJywgJyRldmVudCddKVxuICAgIG9uQmx1cih2YWx1ZSwgZXZlbnQpIHtcbiAgICAgICAgdmFsdWUgPSB2YWx1ZS5yZXBsYWNlKC9cXEQvZywgJycpID8gdGhpcy5vbkxlYXZlKHZhbHVlKS5jb25jYXQodGhpcy5zdWZmaXgpIDogJyc7XG4gICAgICAgIGV2ZW50LnRhcmdldC50b051bWJlciA9IHRoaXMudG9OdW1iZXIodmFsdWUpO1xuICAgICAgICB0aGlzLm5nQ29udHJvbC52YWx1ZUFjY2Vzc29yLndyaXRlVmFsdWUodmFsdWUpO1xuICAgIH1cblxuICAgIEBIb3N0TGlzdGVuZXIoJ25nTW9kZWxDaGFuZ2UnLCBbJyRldmVudCddKVxuICAgIG9uTW9kZWxDaGFuZ2UodmFsdWUpIHtcbiAgICAgICAgdmFsdWUgPSB0aGlzLnRvTnVtYmVyKHZhbHVlKTtcbiAgICAgICAgdmFsdWUgPSB2YWx1ZS5yZXBsYWNlKG5ldyBSZWdFeHAoJ1teMC05fF4nICsgdGhpcy5kZWNpbWFsU2VwYXJhdG9yICsgJ3xeLV0nLCAnZycpLCAnJyk7XG4gICAgICAgIGlmICh2YWx1ZS50b1N0cmluZygpLm1hdGNoKG5ldyBSZWdFeHAoJ15cXC0/WzAtOV0qKCcgKyB0aGlzLmRlY2ltYWxTZXBhcmF0b3IgKyAnWzAtOV0qKT8kJywgJ2cnKSkpIHtcbiAgICAgICAgICAgIGxldCB7dmFsLCBmcmFjfSA9IHRoaXMub25JbnB1dENoYW5nZSh2YWx1ZSk7XG4gICAgICAgICAgICBpZiAodmFsdWUudG9TdHJpbmcoKS5tYXRjaChuZXcgUmVnRXhwKCdeXFwtP1swLTldKiQnLCAnZycpKSkge1xuICAgICAgICAgICAgICAgIHZhbCA9ICghaXNOYU4ocGFyc2VJbnQodmFsLCAxMCkpICYmIHZhbCAhPT0gJy0wJykgPyBwYXJzZUludCh2YWwsIDEwKS50b1N0cmluZygpIDogdmFsO1xuICAgICAgICAgICAgICAgIHZhbHVlID0gdGhpcy5vblRyYW5zZm9ybSh2YWwsIGZyYWMpO1xuICAgICAgICAgICAgICAgIHRoaXMudmFsdWUgPSB0aGlzLnByZWZpeC5jb25jYXQoJyAnKS5jb25jYXQodmFsdWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHZhbHVlLnRvU3RyaW5nKCkubWF0Y2gobmV3IFJlZ0V4cCgnXihcXC0/WzAtOV0pKlsnICsgdGhpcy5kZWNpbWFsU2VwYXJhdG9yICsgJ11bMC05XSokJywgJ2cnKSkgJiZcbiAgICAgICAgICAgICAgICAhdmFsdWUudG9TdHJpbmcoKS5zdGFydHNXaXRoKHRoaXMuZGVjaW1hbFNlcGFyYXRvciwgMCkpIHtcbiAgICAgICAgICAgICAgICBmcmFjID0gZnJhYy5zdWJzdHJpbmcoMCwgdGhpcy5wYWRkaW5nKTtcbiAgICAgICAgICAgICAgICBmcmFjID0gdGhpcy5kZWNpbWFsU2VwYXJhdG9yLmNvbmNhdChmcmFjKTtcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IHRoaXMub25UcmFuc2Zvcm0odmFsLCBmcmFjKTtcbiAgICAgICAgICAgICAgICB0aGlzLnZhbHVlID0gdGhpcy5wcmVmaXguY29uY2F0KCcgJykuY29uY2F0KHZhbHVlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuZWwubmF0aXZlRWxlbWVudC50b051bWJlciA9IHRoaXMudG9OdW1iZXIoXG4gICAgICAgICAgICAgICAgdGhpcy5wcmVmaXguY29uY2F0KCcgJykuY29uY2F0KFxuICAgICAgICAgICAgICAgICAgICB0aGlzLm9uVHJhbnNmb3JtKHZhbCxcbiAgICAgICAgICAgICAgICAgICAgICAgIChwYXJzZUludChmcmFjLnJlcGxhY2UodGhpcy5kZWNpbWFsU2VwYXJhdG9yLCAnJyksIDEwKSA+IDApID9cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhZChmcmFjLCB0aGlzLnBhZGRpbmcgKyAxKS5zdWJzdHJpbmcoMCwgdGhpcy5wYWRkaW5nICsgMSkgOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICcnKSkpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMubmdDb250cm9sLnZhbHVlQWNjZXNzb3Iud3JpdGVWYWx1ZSh0aGlzLnZhbHVlKTtcbiAgICB9XG5cbiAgICBASG9zdExpc3RlbmVyKCdrZXlkb3duJywgWyckZXZlbnQnXSlcbiAgICBvbktleURvd24oZXZlbnQ6IEtleWJvYXJkRXZlbnQpIHtcbiAgICAgICAgaWYgKGV2ZW50LmtleSkge1xuICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgIFsnREVMRVRFJywgJ0JBQ0tTUEFDRScsICdUQUInLCAnRVNDQVBFJyxcbiAgICAgICAgICAgICAgICAnRU5URVInLCAnREVDSU1BTCBQT0lOVCcsICdQRVJJT0QnLCAnREFTSCddLmluZGV4T2YoZXZlbnQua2V5LnRvVXBwZXJDYXNlKCkpICE9PSAtMSB8fFxuICAgICAgICAgICAgICAgIChldmVudC5rZXkudG9VcHBlckNhc2UoKSA9PT0gJ0EnICYmIGV2ZW50LmN0cmxLZXkgPT09IHRydWUpIHx8IC8vIEFsbG93OiBDdHJsK0FcbiAgICAgICAgICAgICAgICAoZXZlbnQua2V5LnRvVXBwZXJDYXNlKCkgPT09ICdDJyAmJiBldmVudC5jdHJsS2V5ID09PSB0cnVlKSB8fCAvLyBBbGxvdzogQ3RybCtDXG4gICAgICAgICAgICAgICAgKGV2ZW50LmtleS50b1VwcGVyQ2FzZSgpID09PSAnVicgJiYgZXZlbnQuY3RybEtleSA9PT0gdHJ1ZSkgfHwgLy8gQWxsb3c6IEN0cmwrVlxuICAgICAgICAgICAgICAgIChldmVudC5rZXkudG9VcHBlckNhc2UoKSA9PT0gJ1gnICYmIGV2ZW50LmN0cmxLZXkgPT09IHRydWUpIHx8IC8vIEFsbG93OiBDdHJsK1hcbiAgICAgICAgICAgICAgICAoZXZlbnQua2V5LnRvVXBwZXJDYXNlKCkgPT09ICdBJyAmJiBldmVudC5tZXRhS2V5ID09PSB0cnVlKSB8fCAvLyBDbWQrQSAoTWFjKVxuICAgICAgICAgICAgICAgIChldmVudC5rZXkudG9VcHBlckNhc2UoKSA9PT0gJ0MnICYmIGV2ZW50Lm1ldGFLZXkgPT09IHRydWUpIHx8IC8vIENtZCtDIChNYWMpXG4gICAgICAgICAgICAgICAgKGV2ZW50LmtleS50b1VwcGVyQ2FzZSgpID09PSAnVicgJiYgZXZlbnQubWV0YUtleSA9PT0gdHJ1ZSkgfHwgLy8gQ21kK1YgKE1hYylcbiAgICAgICAgICAgICAgICAoZXZlbnQua2V5LnRvVXBwZXJDYXNlKCkgPT09ICdYJyAmJiBldmVudC5tZXRhS2V5ID09PSB0cnVlKSB8fCAvLyBDbWQrWCAoTWFjKVxuICAgICAgICAgICAgICAgIChldmVudC5rZXkudG9VcHBlckNhc2UoKSA9PT0gJ0VORCcpIHx8XG4gICAgICAgICAgICAgICAgKGV2ZW50LmtleS50b1VwcGVyQ2FzZSgpID09PSAnSE9NRScpIHx8XG4gICAgICAgICAgICAgICAgKGV2ZW50LmtleS50b1VwcGVyQ2FzZSgpID09PSAnQVJST1dMRUZUJykgfHxcbiAgICAgICAgICAgICAgICAoZXZlbnQua2V5LnRvVXBwZXJDYXNlKCkgPT09ICdBUlJPV1JJR0hUJykgfHwgKGV2ZW50LmtleS5tYXRjaCgvWzAtOS4sXFwtXS9nKSlcbiAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgIHJldHVybjsgIC8vIGxldCBpdCBoYXBwZW4sIGRvbid0IGRvIGFueXRoaW5nXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvLyBFbnN1cmUgdGhhdCBpdCBpcyBhIG51bWJlciBhbmQgc3RvcCB0aGUga2V5cHJlc3NcbiAgICAgICAgLypcbiAgICAgICAgaWYgKChldmVudC5zaGlmdEtleSB8fCAoZXZlbnQua2V5Lm1hdGNoKC9bMC05LixcXC0rXS9nKSkpKSB7XG4gICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICB9XG4gICAgICAgICovXG4gICAgfVxuXG4gICAgb25MZWF2ZSh2YWx1ZSk6IHN0cmluZyB7XG4gICAgICAgIGNvbnN0IHt2YWwsIGZyYWN9ID0gdGhpcy5vbklucHV0Q2hhbmdlKHZhbHVlKTtcbiAgICAgICAgbGV0IGZyYWN0aW9uID0gJyc7XG4gICAgICAgIGlmIChmcmFjKSB7XG4gICAgICAgICAgICBpZiAocGFyc2VJbnQoZnJhYywgMTApID4gMCkge1xuICAgICAgICAgICAgICBmcmFjdGlvbiA9IHRoaXMuZGVjaW1hbFNlcGFyYXRvciArIHRoaXMucGFkKGZyYWMsIHRoaXMucGFkZGluZykuc3Vic3RyaW5nKDAsIHRoaXMucGFkZGluZyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMub25UcmFuc2Zvcm0odmFsLCBmcmFjdGlvbik7XG4gICAgfVxuXG4gICAgb25JbnB1dENoYW5nZSh2YWx1ZSk6IHt2YWw6IHN0cmluZywgZnJhYzogc3RyaW5nfSB7XG4gICAgICAgIGNvbnN0IFsgdmFsID0gJycsIGZyYWN0aW9uID0gJyddID0gKHZhbHVlIHx8ICcnKS5zcGxpdCh0aGlzLmRlY2ltYWxTZXBhcmF0b3IpO1xuICAgICAgICByZXR1cm4ge3ZhbCA6IHZhbCwgZnJhYzogZnJhY3Rpb259O1xuICAgIH1cblxuICAgIG9uVHJhbnNmb3JtKHZhbDogc3RyaW5nLCBmcmFjdGlvbjogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAgIHZhbCA9IHZhbC5yZXBsYWNlKC9cXEIoPz0oXFxkezN9KSsoPyFcXGQpKS9nLCB0aGlzLnRob3VzYW5kc1NlcGFyYXRvcik7XG4gICAgICByZXR1cm4gdmFsICsgZnJhY3Rpb247XG4gICAgfVxuXG4gICAgdG9OdW1iZXIodmFsOiBzdHJpbmcpIHtcbiAgICAgICAgcmV0dXJuIHZhbFxuICAgICAgICAgICAgLnJlcGxhY2UodGhpcy5wcmVmaXgsICcnKVxuICAgICAgICAgICAgLnJlcGxhY2UoJyAnLCAnJylcbiAgICAgICAgICAgIC5yZXBsYWNlKHRoaXMuc3VmZml4LCAnJylcbiAgICAgICAgICAgIC5yZXBsYWNlKG5ldyBSZWdFeHAodGhpcy50aG91c2FuZHNTZXBhcmF0b3IsICdnJyksICcnKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHBhZCh2YWwsIHNpemUpOiBzdHJpbmcge1xuICAgICAgICB3aGlsZSAodmFsLmxlbmd0aCA8IHNpemUpIHZhbCA9IHZhbCArICcwJztcbiAgICAgICAgcmV0dXJuIHZhbDtcbiAgICB9XG59XG4iXX0=